<!DOCTYPE html>
<html>
<head>
    <title>MaybePad</title>
    <script src="https://cdn.ckeditor.com/4.14.0/standard/ckeditor.js"></script>
</head>
<body>
<textarea name="editor" id="editor"></textarea>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    var editor = CKEDITOR.replace('editor');
    var lastSavedContent;

    CKEDITOR.on('instanceReady',
        function( evt )
        {
            var editor = evt.editor;
            editor.execCommand('maximize');
        });

    var path = window.location.pathname;
    console.log(path);

    function debounce(func, wait) {
        var timeout;

        return function executedFunction() {
            var context = this;
            var args = arguments;

            var later = function() {
                timeout = null;
                func.apply(context, args);
            };

            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    };

    function saveContent() {
        var currentContent = editor.getData();

        // Only save the content if it's different from the last saved content
        if(currentContent !== lastSavedContent) {
            $.ajax({
                url: '/api' + path,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    path: path,
                    content: currentContent
                }),
                success: function() {
                    console.log('Saved');
                    lastSavedContent = currentContent;
                    loadContent();
                }
            });
        }
    }

    function loadContent() {
        $.ajax({
            url: '/api' + path,
            type: 'GET',
            success: function(data) {
                console.log("get ok")
                console.log(data)
                editor.setData(data.content);
                lastSavedContent = data.content;
            }
        });
    }

    loadContent();
    var saveContentDebounced = debounce(saveContent, 2000);
    editor.on('change', saveContentDebounced);
</script>
</body>
</html>
